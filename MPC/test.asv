%台形近似の係数
n = param.n;
m = param.mass;
dt = param.dt;
dt = 10;

A_ = [0, 0, 0, 1/2, 0, 0;
     0, 0, 0, 0, 1/2, 0;
     0, 0, 0, 0, 0, 1/2;
     0, 0, 0, 0, 0, 2*n;
     0, -n^2, 0, 0, 0, 0;
     0, 0, 3*n^2, -2*n, 0, 0]+...
    [0, 0, 0, 1, 0, 2*n;
     0, -n^2, 0, 0, 1, 0;
     0, 0, 3*n^2, -2*n, 0, 1;
     0, 0, 0, 0, 0, 0;
     0, 0, 0, 0, 0, 0;
     0, 0, 0, 0, 0, 0]/2;

B_ = [0, 0, 0;
     0, 0, 0;
     0, 0, 0;
     1/m, 0, 0;
     0, 1/m, 0;
     0, 0, 1/m];

A_d = eye(6) + param.dt*A_;
B_d = param.dt*B_;

%最適化する時間。
N = 1000;

%目標位置
x_d = [0.3; 0.3; 0];

%S = PU + Qs_0
P = controllability_matrix(A_d, B_d, N); %6n×3n
Q = controllability_matrix2(A_d, N); %6n×6

%初期状態
s0 = [0.1; 0.9; 0; 0; 0; 0];

%最大加速度
u_max = ones(3*N, 1)*10^(-3);

%評価関数(位置に関する関数)
%J = xKx
K = zeros(6*N);%6n×6n
K(1:3, 1:6) = eye(6);

%評価関数(時系列入力に関する関数)
%J = uKu
H = P.' * K * P;
f = s0.' * Q.' * K * P;

%拘束条件(時系列入力に関する関数)
% u < u_max
A = eye(3*N);
ub = u_max;
lb = -u_max;

[x,fval,exitflag,output,lambda] = ...
   quadprog(H, f, [], [], [], [], lb, ub);

s = P * x + Q *  s0;
